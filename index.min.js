!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("schemaBundler",[],t):"object"==typeof exports?exports.schemaBundler=t():e.schemaBundler=t()}(this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var a=r[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,t),a.l=!0,a.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e){if(null===e||"object"!==(void 0===e?"undefined":f(e)))return e;var t=e.constructor();for(var r in e)e.hasOwnProperty(r)&&(t[r]=a(e[r]));return t}function i(e,t){for(var r=e.split("/"),n=t.split("/");void 0!==n[0]&&r.shift()===n[0];)n.shift();return n.join("/")}function o(e){var t=e.split(".");return t[t.length-1]}Object.defineProperty(t,"__esModule",{value:!0}),r.d(t,"Schema",function(){return s});var l=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function(){function e(t,r,a,i){n(this,e),this.cache={},this.totalFiles=0,this.loadedFiles=0,this.DEFINITIONS="definitions",this.url=t,this.progress=r,this.yamlParse=a||jsyaml.load,this.httpGet=i||axios.get}return l(e,[{key:"load",value:function(){return this.loadFile(this.url)}},{key:"bundle",value:function(){this.bundled=a(this.cache[this.url]),this.refs=this.bundlePart(this.bundled,this.url),this.refs=1===Object.keys(this.cache).length?this.refs:this.getRefs(this.bundled),this.simplifyRefs(this.refs)}},{key:"deref",value:function(){var e=this,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.refs,a={};if(t){if(n.forEach(function(t){a[t.val.$ref]=a[t.val.$ref]||e.getObjectByPath(e.bundled,t.val.$ref,!1)}),n.forEach(function(e){void 0!==a[e.val.$ref].val&&(e.owner[e.key]=a[e.val.$ref].val)}),!r)return;var i={},o=n.filter(function(e){return e.val===e.owner[e.key]});o.forEach(function(t){o[t.val.$ref]=o[t.val.$ref]||e.getObjectByPath(e.bundled,t.val.$ref,!1)}),Object.keys(a).forEach(function(e){var t=e.split("/");t.pop();var r=t.join("/");if(i[r]=!0,!a[r]&&!o[e]){var n=a[e];delete n.owner[n.key]}}),Object.keys(i).forEach(function(t){var r=e.getObjectByPath(e.bundled,t,!1);r.val&&0===Object.keys(r.val).length&&delete r.owner[r.key]});var l=this.cache[this.url];for(var f in this.bundled)l.hasOwnProperty(f)||delete this.bundled[f]}else n.forEach(function(t){t.val.$deref=t.val.$deref||e.getObjectByPath(e.bundled,t.val.$ref).val})}},{key:"bundledPath",value:function(e,t){var r="#"+(e?"/"+e:"")+(t||""),n=r.split("/");return n[1]===this.DEFINITIONS||this.bundled[n[1]]||n.splice(1,0,this.DEFINITIONS),n.join("/")}},{key:"getRefs",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=arguments[3],a=arguments[4];e&&e.$ref&&"string"==typeof e.$ref&&t.push({val:e,owner:n,key:a});for(var i=0,o=Object.keys(e);i<o.length;i++){var l=o[i];e[l]&&"object"===f(e[l])&&-1===r.indexOf(e[l])&&(r.push(e[l]),this.getRefs(e[l],t,r,e,l))}return t}},{key:"getUrls",value:function(e,t){var r=this,n={};return e.forEach(function(e){var a=new URL(e.val.$ref,t),i=a.origin+a.pathname;r.cache[i]||n[i]||!a.pathname||(n[i]=!0)}),Object.keys(n)}},{key:"parseFile",value:function(e,t){var r=this,n=this.getRefs(e),a=this.getUrls(n,t),i=[];return a.forEach(function(e){i.push(r.loadFile(e))}),Promise.all(i)}},{key:"report",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.progress&&this.progress({total:this.totalFiles,loaded:this.loadedFiles,cached:e})}},{key:"loadFile",value:function(e){var t=this;return new Promise(function(r,n){t.cache[e]?(t.totalFiles++,t.loadedFiles++,t.report(!0),t.parseFile(t.cache[e],e).then(r)):(t.cache[e]=!0,t.totalFiles++,t.report(),t.httpGet(e).then(function(n){if(t.loadedFiles++,t.report(),"string"==typeof n.data&&(n.headers&&n.headers["content-type"]&&n.headers["content-type"].indexOf("yaml")>-1||"yaml"===o(e).toLowerCase()))try{n.data=t.yamlParse(n.data)}catch(e){}t.cache[e]=n.data,t.parseFile(t.cache[e],e).then(r)}).catch(function(e){n(e)}))})}},{key:"getObjectByPath",value:function(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=(t||"").split("/");n.shift();var a=e,i=null,o=null,l=!0,f=!1,s=void 0;try{for(var u,c=n[Symbol.iterator]();!(l=(u=c.next()).done);l=!0){var h=u.value;if(!a)break;i=decodeURIComponent(h),a[i]=void 0!==a[i]?a[i]:r?{}:void 0,o=a,a=a[i]}}catch(e){f=!0,s=e}finally{try{!l&&c.return&&c.return()}finally{if(f)throw s}}return{val:a,owner:o,key:i}}},{key:"getObjectByUrl",value:function(e){var t=e.origin+e.pathname;return this.getObjectByPath(this.cache[t],e.hash)}},{key:"bundlePart",value:function(t,r){var n=this,o=this.getRefs(t),l=new URL(r,this.url),s=[];return o.forEach(function(t){var r=new URL(t.val.$ref,l.href),o=r.origin+r.pathname,u=i(n.url,o),c=n.bundledPath(u,r.hash),h=n.getObjectByUrl(r);if(h.val&&"object"===f(h.val)){var d=n.getObjectByPath(n.bundled,c);!e.isRef(d.val)||d.val.$ref&&d.val.$ref===h.val.$ref||(h.val.$ref?d.val.$ref=h.val.$ref:Object.assign(d.val,a(h.val)),t.val.$ref=c,s.push([d.val,o]))}else if(!h.val||"object"!==f(h.val)){var v=n.getObjectByPath(n.bundled,c);v.owner[v.key]=h.val}t.val.$ref=c}),s.forEach(function(e){return n.bundlePart(e[0],e[1])}),o}},{key:"followRef",value:function(e){var t=e.split("/");t.shift();for(var r=this.bundled,n=[],a=0;a<t.length;a++){r=r[decodeURIComponent(t[a])];if(!(r&&a+1<t.length?r[decodeURIComponent(t[a+1])]:null)&&r&&r.$ref&&r.$ref!==e){if(n.indexOf(r)>-1)break;n.push(r);var i=t.slice(a+1);i.unshift(r.$ref),t=i.join("/").split("/"),t.shift(),a=0,r=this.bundled,r=r[decodeURIComponent(t[a])]}else if(!r)break}return t.unshift("#"),t.join("/")}},{key:"simplifyRefs",value:function(e){var t=this;e.forEach(function(e){e.val.$ref=t.followRef(e.val.$ref)})}}],[{key:"isRef",value:function(e){return Object.keys(e).length-(e.$ref?1:0)==0}}]),e}()}])});